<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prototype the markup and javascript to create the streetviews for turn by turn trip planner</title>
    <style type="text/css">

        .street-views {
            /*display: flex;*/
            /*flex-flow: row wrap;*/
          width: 600px;

        }

        .street-view-container {
            width: 100%;
            height: 300px;
            margin: 2px;

            background-color: #07fef6;
        }

        .street-view-description {
            width: 100%;
            height: 1em;
            margin: 2px;

            background-color: #e0bf9c;
        }
      .hidden-template {
        display: none;
      }
    </style>
</head>
<body>
<div class="hidden-template">
  <div class="panorama-template">
      <div class="street-view-description"></div>
      <div class="street-view-container"></div>
  </div>
</div>


<div class="street-views">

</div>

<script>

    //TODO: Bogus global
    var steps = [
        {
            instructions: "Head <b>south</b> on <b>Melissa Ave</b> toward <b>Melissa Ct</b>",
            start_location: {
                lat: function () {
                    return 34.8935494;
                },
                lng: function () {
                    return -117.0169148;
                }
            },
            end_location: {
                lat: function () {
                    return 34.8934234;
                },
                lng: function () {
                    return -117.02292239999997;
                }
            }
        },
        {
            instructions: "Turn <b>right</b> onto <b>E Mountain View St</b>",
            start_location: {
                lat: function () {
                    return 34.8934234;
                },
                lng: function () {
                    return -117.02292239999997;
                }
            },
            end_location: {
                lat: function () {
                    return 34.8870383;
                },
                lng: function () {
                    return -117.02293480000003;
                }
            }
        },
        {
            instructions: "Turn <b>left</b> onto <b>Barstow Rd</b>",
            start_location: {
                lat: function () {
                    return 34.8870383;
                },
                lng: function () {
                    return -117.02293480000003;
                }
            },
            end_location: {
                lat: function () {
                    return 34.8861495;
                },
                lng: function () {
                    return -117.02649020000001;
                }
            }
        }
    ];
    var streetViewData, instructions;

    /* General functions */

    function isOneOrMoreArrayLike( object ) {
        return object && object.length && object.length >= 1;
    }

    function consoleShiv() {
        if (!console) {
            console = {
                error: function() {}
            }
        }
    }

    /* Google maps specific */

    function parseLatLngForStep(propertyName, step) {

        return {
            lat: step[propertyName].lat(),
            lng: step[propertyName].lng()
        }
    }

    function parseLatLng(steps) {
        var i, latLngArray = new Array(steps.length + 1);

        latLngArray[0] = parseLatLngForStep('start_location', steps[0]);

        for ( i = 0 ; i < steps.length ; i++) {
            latLngArray[i + 1] = parseLatLngForStep('end_location', steps[i])
        }

        return latLngArray;
    }

    function addInstructions(steps, streetViewData) {
        var i;

        for (i = 0 ; i < steps.length ; i++) {
            streetViewData[i].instructions = steps[i].instructions;
        }
        streetViewData[i].instructions = "You have reached your destination";
    }

    /* DOM specific */

    function appendTemplateCopies(domContainer, domTemplate, copyCount) {
        var i;

        for (i = 0; i < copyCount; i++) {

            domContainer.appendChild( domTemplate.cloneNode(true) );
        }
    }

    /* Multiple API dependencies */

    /**
     * May have multiple templates and view containers with user choosing different views
     */
    function createStreetViewContainers(containerClass, templateClass, copyCount) {
        var templateElementArray = document.getElementsByClassName(templateClass),
                containerElementArray = document.getElementsByClassName(containerClass);

        try  {
            appendTemplateCopies(containerElementArray[0], templateElementArray[0], copyCount);
        } catch (e)  {
            console.error(e.stack);
            console.error("Require template [" + templateClass + "] target container [" + containerClass + "]")
        }
    }

    function addStreetViews(streetViewSelector, descriptionSelector, streetViewData) {
        var streetViewElementArray = document.querySelectorAll(streetViewSelector),
                descriptionElementArray = document.querySelectorAll(descriptionSelector),
                i, panorama;
        try {
            for (i = 0; i < streetViewData.length ; i++) {
                panorama = new google.maps.StreetViewPanorama(
                        streetViewElementArray[i], {
                            position: streetViewData[i]
                        });
                descriptionElementArray[i].innerHTML = streetViewData.instructions;
            }
        } catch (e) {
            console.error(e.stack);
        }

    }

    // Main function calls
    function displayPrototype() {
        consoleShiv();

        createStreetViewContainers("street-views", "panorama-template", (steps.length + 1));

        //Small performance hit in traversing repeatedly so logic is simpler. Will never have 100 steps
        streetViewData = parseLatLng(steps);
        addInstructions(steps, streetViewData);
        if (streetViewData.length > 0) {
            addStreetViews(".street-views .street-view-container", ".street-views .street-view-description",
                    streetViewData);
        }
    }
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-AvlmDgL5SASp1DZYxT3ZHNyiuS-SJC8&callback=displayPrototype">
</script>
</body>
</html>